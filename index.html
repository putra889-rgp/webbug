<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>putraxyofficial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
    body { font-family: "Press Start 2P", cursive; background: #0f172a; color: #e0e0e0; }
    .container { max-width:480px; margin:2rem auto; padding:1rem; }
  </style>
</head>
<body>
  <main class="container">
    <div class="text-center mb-6">
      <h1 class="text-2xl text-blue-400 select-none">putraxyofficial</h1>
      <p class="text-xs text-cyan-300 mt-2">Panel: Buyer / Developer — putraxyofficial</p>
    </div>

    <!-- Login modal simplified -->
    <div id="loginModal" class="mb-4 p-4 bg-slate-900 rounded">
      <div class="mb-3 text-sm text-cyan-300">Login Menu</div>
      <div class="flex gap-2">
        <button onclick="openBuyerMenu()" class="flex-1 px-3 py-2 bg-cyan-700 rounded text-xs">Buyer</button>
        <button onclick="openDevModal()" class="flex-1 px-3 py-2 bg-pink-700 rounded text-xs">Developer</button>
      </div>
    </div>

    <!-- Developer modal -->
    <div id="devModal" class="hidden p-4 bg-slate-900 rounded mb-4">
      <div class="text-sm text-pink-300 mb-2">Developer Login</div>
      <input id="devUser" placeholder="Username" class="w-full mb-2 px-2 py-2 rounded bg-slate-800 text-xs"/>
      <input id="devPass" type="password" placeholder="Password" class="w-full mb-2 px-2 py-2 rounded bg-slate-800 text-xs"/>
      <div class="flex gap-2">
        <button onclick="devLogin()" class="flex-1 px-3 py-2 bg-pink-600 rounded text-xs">Login</button>
        <button onclick="backToLogin()" class="flex-1 px-3 py-2 bg-slate-700 rounded text-xs">Back</button>
      </div>
      <p id="devError" class="text-yellow-300 text-xs mt-2"></p>
    </div>

    <!-- Dev Panel -->
    <div id="devPanel" class="hidden p-4 bg-slate-900 rounded mb-4">
      <div class="text-sm text-pink-300 mb-3">Developer Panel</div>
      <button onclick="toggleBlock()" class="w-full mb-2 px-3 py-2 bg-pink-600 rounded text-xs">Toggle Buyer Access</button>
      <button onclick="backToLogin()" class="w-full px-3 py-2 bg-slate-700 rounded text-xs">Logout</button>
    </div>

    <!-- Buyer menu -->
    <div id="menuBtn" class="hidden mb-4">
      <button onclick="showForm()" class="w-full px-4 py-3 bg-black text-cyan-400 border-2 border-pink-600 rounded text-xs">Open Attack Form</button>
    </div>

    <!-- Form -->
    <div id="formSection" class="hidden p-4 bg-slate-900 rounded">
      <div class="text-sm text-cyan-300 mb-2">Attack Form</div>
      <input id="number" placeholder="Nomor tujuan (contoh: +62812...)" class="w-full mb-3 px-2 py-2 rounded bg-slate-800 text-xs" />
      <button id="sendBtn" onclick="sendBug()" class="w-full px-4 py-3 bg-cyan-700 rounded text-xs mb-2">Send Bug</button>
      <p id="status" class="text-xs text-yellow-300 min-h-[1.25rem]"></p>

      <!-- OTP verification area (hidden until send) -->
      <div id="verifyArea" class="mt-3 hidden">
        <div class="text-xs text-cyan-300 mb-2">Masukkan kode OTP yang diterima</div>
        <input id="otpInput" placeholder="Kode OTP" class="w-full mb-2 px-2 py-2 rounded bg-slate-800 text-xs" />
        <div class="flex gap-2">
          <button onclick="verifyOtp()" class="flex-1 px-3 py-2 bg-green-600 rounded text-xs">Verify</button>
          <button onclick="resendOtp()" class="flex-1 px-3 py-2 bg-yellow-600 rounded text-xs">Resend</button>
        </div>
        <p id="verifyStatus" class="text-xs text-yellow-300 mt-2 min-h-[1.25rem]"></p>
      </div>
    </div>

    <footer class="mt-6 text-xs text-gray-400 text-center">
      © putraxyofficial
    </footer>
  </main>

  <script>
    // key used in localStorage for blocking buyer access
    const BLOCK_FLAG = 'putraxyofficial';

    function openBuyerMenu() {
      if (localStorage.getItem(BLOCK_FLAG) === 'true') {
        alert("Situs diblokir oleh putraxyofficial. Tidak bisa digunakan.");
        return;
      }
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('menuBtn').classList.remove('hidden');
    }

    function openDevModal() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('devModal').classList.remove('hidden');
    }

    function backToLogin() {
      document.getElementById('devPanel').classList.add('hidden');
      document.getElementById('devModal').classList.add('hidden');
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('menuBtn').classList.add('hidden');
    }

    function toggleBlock() {
      let isBlocked = localStorage.getItem(BLOCK_FLAG) === 'true';
      localStorage.setItem(BLOCK_FLAG, (!isBlocked).toString());
      alert(isBlocked ? "Blokir dimatikan (Buyer bisa akses)" : "Situs berhasil diblokir oleh putraxyofficial (Buyer tidak bisa akses)");
    }

    function devLogin() {
      const user = document.getElementById('devUser').value.trim();
      const pass = document.getElementById('devPass').value.trim();
      const error = document.getElementById('devError');
      if (user === 'dev' && pass === 'devpass') {
        error.textContent = "";
        document.getElementById('devModal').classList.add('hidden');
        document.getElementById('devPanel').classList.remove('hidden');
      } else {
        error.textContent = "Username atau password salah.";
      }
    }

    function showForm() {
      const form = document.getElementById("formSection");
      if (form.classList.contains("hidden")) {
        form.classList.remove("hidden");
        form.scrollIntoView({ behavior: "smooth" });
      }
    }

    // store last sent number to use in verify/resend
    let _lastNumber = null;

    async function sendBug() {
      const number = document.getElementById("number").value.trim();
      const status = document.getElementById("status");
      const verifyArea = document.getElementById("verifyArea");
      document.getElementById("verifyStatus").innerText = "";
      if (!number) {
        status.innerText = "Masukkan nomor target yang valid!";
        return;
      }
      status.innerText = "Mengirim OTP...";
      try {
        const res = await fetch("/start-attack", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ number, jumlah: 1 })
        });
        const data = await res.json().catch(()=>({}));
        if (res.ok) {
          status.innerText = "OTP dikirim. Masukkan kode di bawah.";
          _lastNumber = number;
          verifyArea.classList.remove("hidden");
        } else {
          status.innerText = data.error || data.message || "Terjadi kesalahan server.";
        }
      } catch (e) {
        status.innerText = "Gagal mengirim. Periksa koneksi.";
      }
    }

    async function resendOtp() {
      if (!_lastNumber) {
        document.getElementById("verifyStatus").innerText = "Tidak ada nomor untuk di-resend.";
        return;
      }
      document.getElementById("verifyStatus").innerText = "Mengirim ulang OTP...";
      try {
        const res = await fetch("/start-attack", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ number: _lastNumber, jumlah: 1 })
        });
        const data = await res.json().catch(()=>({}));
        if (res.ok) {
          document.getElementById("verifyStatus").innerText = "OTP dikirim ulang.";
        } else {
          document.getElementById("verifyStatus").innerText = data.error || data.message || "Gagal resend.";
        }
      } catch (e) {
        document.getElementById("verifyStatus").innerText = "Gagal mengirim ulang.";
      }
    }

    async function verifyOtp() {
      const otp = document.getElementById("otpInput").value.trim();
      const verifyStatus = document.getElementById("verifyStatus");
      if (!otp || !_lastNumber) {
        verifyStatus.innerText = "Masukkan kode OTP dan pastikan sudah mengirim.";
        return;
      }
      verifyStatus.innerText = "Memverifikasi...";
      try {
        const res = await fetch("/api/verify-otp", { // call API verify directly (no rewrite)
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ number: _lastNumber, otp })
        });
        const data = await res.json().catch(()=>({}));
        if (res.ok && data.ok) {
          verifyStatus.innerText = "OTP valid. Verifikasi berhasil.";
          // optional: hide verify area, or mark session
        } else {
          verifyStatus.innerText = data.reason || data.error || "OTP tidak valid.";
        }
      } catch (e) {
        verifyStatus.innerText = "Gagal verifikasi.";
      }
    }

    async function checkWAStatus() {
      try {
        const res = await fetch("/status");
        const data = await res.json().catch(()=>({}));
        // do nothing fancy, could show indicator
      } catch(e) {}
    }
    setInterval(checkWAStatus, 5000);
    checkWAStatus();
  </script>
</body>
</html>
